[原文地址](https://engineering.videoblocks.com/web-architecture-101-a3224e126947)

# WEB架构101

## 基本的架构概念，我希望自己刚开始做网页开发时就知道

![img](https://miro.medium.com/max/998/1*K6M-x-6e39jMq_c-2xqZIQ.png)

上面的图表是我们的架构在 Storyblocks 中的一个相当好的表示。 如果你不是一个经验丰富的 web 开发人员，你可能会发现它很复杂。 在我们深入研究每个组件的细节之前，下面的步骤应该使它更加易于理解。

> *一位用户在谷歌上搜索“森林中的浓雾和阳光”。 第一个结果恰好来自 Storyblocks，我们领先的图片和矢量网站。 用户点击结果，结果将浏览器重定向到图像详细信息页面。 在引擎盖下面，用户的浏览器向 DNS 服务器发送一个请求，查找如何联系 Storyblocks，然后发送请求。*
>
> *请求访问我们的负载均衡器，它随机选择10个左右运行站点的 web 服务器中的一个来处理请求。 Web 服务器从我们的缓存服务中查找有关图像的一些信息，并从数据库中获取有关图像的剩余数据。 我们注意到图像的颜色配置文件还没有被计算出来，因此我们向作业队列发送一个“颜色配置文件”作业，我们的作业服务器将异步处理这个作业队列，并根据结果适当地更新数据库。*
>
> *接下来，我们尝试通过发送请求到我们的全文搜索服务，使用照片的标题作为输入来寻找类似的照片。 用户碰巧是一个登录到 Storyblocks 的成员，所以我们从我们的帐户服务查找他的帐户信息。 最后，我们向我们的云存储系统记录的数据消防水管发出一个页面视图事件，并最终加载到我们的数据仓库中，分析师用这个数据仓库来帮助回答有关业务的问题。*
>
> *现在，服务器将视图呈现为 HTML，并将其发送回用户的浏览器，首先通过负载均衡器进行传递。 该页面包含我们加载到云存储系统中的 Javascript 和 CSS 资产，云存储系统连接到我们的 CDN，因此用户的浏览器联系 CDN 来检索内容。 最后，浏览器显示页面，让用户可以看到。*

接下来，我将向您介绍每个组件，并为每个组件提供一个“101”介绍，这将为您提供一个良好的心理模型，以便您考虑未来的 web 架构。 接下来，我将根据我在 Storyblocks 学到的东西，撰写另一系列文章，提供具体的实施建议。

# 1. DNS

Dns 代表“域名系统” ，它是使万维网成为可能的主干技术。 在最基本的层面上，DNS 提供了从域名(例如，google. com)到 IP 地址(例如，85.129.83.120)的键 / 值查询，这是您的计算机将请求路由到适当的服务器所必需的。 类似于电话号码，域名和 IP 地址之间的区别就是“ call John Doe”和“ call 201-867-5309”之间的区别 就像过去你需要一本电话簿来查找 John 的电话号码一样，你也需要 DNS 来查找一个域名的 IP 地址。 所以你可以把 DNS 想象成互联网的电话簿。

# 2. Load Balancer

在深入研究负载平衡的细节之前，我们需要回过头来讨论横向与纵向应用程序伸缩。 它们是什么，有什么区别？ 简单地说，水平扩展意味着你可以在你的资源池中增加更多的机器，而“垂直”扩展意味着你可以在现有的机器上增加更多的能量(例如，CPU，RAM)。

在 web 开发中，你(几乎)总是希望水平伸缩，因为为了保持简单，东西会断裂。 服务器随机崩溃。 网络退化。 整个数据中心有时会离线。 拥有多个服务器允许您计划中断，以便您的应用程序继续运行。 换句话说，你的应用是“容错的” 其次，水平扩展允许您最小限度地将应用程序后端的不同部分(web 服务器、数据库、服务 x 等)连接在一起，方法是让每个部分在不同的服务器上运行。 最后，你可能会达到一个规模，它不可能垂直规模更多。 世界上没有足够大的电脑可以完成你所有的应用程序计算。 谷歌的搜索平台是一个典型的例子，尽管这适用于规模更小的公司。 例如，Storyblocks 在任意给定的时间点上运行150到400个 AWS EC2实例。 通过垂直扩展来提供完整的计算能力是一个挑战。

好了，回到负载均衡器。 它们是神奇的酱汁，使水平伸缩成为可能。 它们将传入的请求路由到许多应用服务器之一，这些应用服务器通常是彼此的克隆 / 镜像，并将响应从应用服务器发送回客户机。 他们中的任何一个都应该以相同的方式处理请求，因此只需要将请求分布到服务器集合中，这样就不会有任何服务器超载。

就是这样。 从概念上讲，负载均衡器是相当直接的。 在引擎盖下当然有复杂性，但没有必要潜入我们的101版本。

# 3. Web Application Servers

在高层次上，web 应用服务器的描述相对简单。 它们执行处理用户请求的核心业务逻辑，并将 HTML 发送回用户的浏览器。 为了完成它们的工作，它们通常与各种后端基础结构通信，如数据库、缓存层、作业队列、搜索服务、其他微型服务、数据 / 日志记录队列等。 正如上面提到的，为了处理用户请求，您通常至少有两个并且经常有更多个插入到负载均衡器中。

你应该知道应用服务器实现需要选择一种特定的语言(Node.js，Ruby，PHP，Scala，Java，c #)。 Net 等)和该语言的 web MVC 框架(Express for Node.js，Ruby on Rails，Play for Scala，Laravel for PHP 等)。 但是，深入研究这些语言和框架的细节超出了本文的范围。

# 4. 数据库服务器

每个现代 web 应用程序都利用一个或多个数据库来存储信息。 数据库提供了定义数据结构、插入新数据、查找现有数据、更新或删除现有数据、跨数据执行计算等等的方法。 在大多数情况下，网络应用服务器和作业服务器直接对话。 此外，每个后端服务可能有自己的数据库，与应用程序的其余部分隔离开来。

虽然我避免对每个体系结构组件的特定技术进行深入研究，但是如果不提及数据库的下一个层次的细节: SQL 和 NoSQL，那么我就是在给您带来伤害。

Sql 代表“ SQL 数据库” ，它是在20世纪70年代发明的，用于提供一种标准的方式来查询关系数据集，这种方式可以被广泛的用户使用。 Sql 数据库将数据存储在通过公共 id (通常是整数)链接在一起的表中。 让我们来看一个为用户存储历史地址信息的简单示例。 您可能有两个表，用户和用户地址，通过用户 id 链接在一起。 看看下面的图片，看看简单的版本。 之所以链接这些表，是因为用户地址中的用户 id 列是用户表中 id 列的“外键”。

![img](https://miro.medium.com/max/677/1*Ln39QPggpJVMAScUBsrcCQ.png)

如果你对 SQL 了解不多，我强烈建议你浏览一下可汗学院的教程。 它在 web 开发中无处不在，所以你至少需要了解一些基础知识，以便正确地构建一个应用程序。

Nosql 是“ Non-SQL”的缩写，是一种新的数据库技术，可以处理大规模 web 应用程序可能产生的大量数据(大多数 SQL 变体在水平方向上不能很好地伸缩，只能垂直伸缩到某一点)。 如果你对 NoSQL 一无所知，我建议你从一些高层次的介绍开始:

- https://www.w3resource.com/mongodb/nosql.php
- http://www.kdnuggets.com/2016/07/seven-steps-understanding-nosql-databases.html
- https://resources.mongodb.com/getting-started-with-mongodb/back-to-basics-1-introduction-to-nosql

我还要记住，总的来说，业界正在将 SQL 作为 NoSQL 数据库的接口，所以如果你不知道的话，你真的应该学习 SQL。 现在几乎没有办法避免这种情况。

# 5. Caching Service

缓存服务提供了一个简单的键 / 值数据存储，可以在接近 o (1)的时间内保存和查找信息。 应用程序通常利用缓存服务来保存昂贵的计算结果，这样就可以从缓存中检索结果，而不是在下次需要时重新计算结果。 应用程序可以缓存来自数据库查询的结果、对外部服务的调用、给定 URL 的 HTML 等等。 这里有一些来自现实世界应用的例子:

- 谷歌缓存搜索结果的常见搜索查询，如“狗”或“泰勒斯威夫特” ，而不是重新计算他们每次
- 缓存了你登录时看到的大部分数据，比如发布数据、好友等等。 阅读一篇关于 Facebook 缓存技术的详细文章[here 这里](https://medium.com/@shagun/scaling-memcache-at-facebook-1ba77d71c082).
- Storyblocks 缓存服务器端的 HTML 输出 React rendering、搜索结果、 typeahead 结果等等

两种最广泛使用的缓存服务器技术是 Redis 和 Memcache。



# 6. Job Queue & Servers

大多数 web 应用程序需要在幕后异步执行一些与响应用户请求没有直接关联的工作。 例如，谷歌需要爬行和索引整个互联网，以便返回搜索结果。 并不是每次你搜索的时候都会这样。 相反，它异步地抓取网页，沿途更新搜索索引。

虽然有不同的体系结构支持异步工作，但最普遍的是我称之为“作业队列”体系结构的体系结构。 它由两个组件组成: 需要运行的“作业”队列和运行队列中作业的一个或多个作业服务器(通常称为“ workers”)。

作业队列存储需要异步运行的作业列表。 最简单的是先进先出(FIFO)队列，尽管大多数应用程序最终需要某种优先级排队系统。 每当应用程序需要运行一个作业时，无论是按照某种常规调度还是根据用户操作来决定，它都只是将适当的作业添加到队列中。

例如，Storyblocks 利用工作队列为支持我们的市场所需的许多幕后工作提供动力。 我们运行作业来编码视频和照片，处理标记元数据的 csv，聚合用户统计，发送密码重置邮件，等等。 我们从一个简单的 FIFO 队列开始，虽然我们升级到一个优先级队列，以确保时间敏感的操作，如发送密码重置电子邮件尽快完成。

作业服务器处理作业。 他们对作业队列进行轮询，以确定是否有工作要做，如果有，则从队列中取出一个作业并执行该作业。 底层语言和框架的选择和 web 服务器一样多，所以我不会在本文中详细讨论。

# 7. Full-text Search Service

许多(如果不是大多数)网络应用程序支持某种搜索功能，用户提供一个文本输入(通常称为“查询”) ，应用程序返回最“相关”的结果。 支持这一功能的技术通常被称为“全文搜索” ，它利用倒排索引快速查找包含查询关键字的文档。

![img](https://miro.medium.com/max/842/1*gun_BpdDH9KrNna1NnaocA.png)

<center>文档标题转换为倒排索引，以方便从特定关键字快速查找标题中包含该关键字的文档。 注意，常见的单词，如“ in”、“ the”、“ with”等(称为“ stop words”) ，通常不包含在倒排索引中</center>

虽然可以直接从某些数据库进行全文搜索(例如，MySQL 支持全文搜索) ，但通常会运行一个单独的“搜索服务” ，计算和存储倒排索引并提供查询界面。 目前最流行的全文搜索平台是 Elasticsearch，不过也有其他选项，如 Sphinx 或 apachesolr。

# 8. Services

一旦一个应用程序达到一定规模，就可能会有某些“服务”作为单独的应用程序运行。 他们不会暴露在外部世界中，但是应用程序和其他服务会与他们交互。 例如，Storyblocks 有几个可操作的和计划中的服务:

- **Account service** 帐户服务存储用户数据跨越我们所有的网站，这使我们能够轻松地提供交叉销售的机会，并创造一个更加统一的用户体验
- **Content service** 内容服务存储所有视频、音频和图像内容的元数据。 它还提供了用于下载内容和查看下载历史的界面
- **Payment service**  支付服务为客户信用卡计费提供了一个界面
- **HTML → PDF service** Html → PDF 服务提供了一个简单的接口，它接受 HTML 并返回相应的 PDF 文档

# 9. Data

今天，公司的生死取决于他们如何很好地利用数据。 如今，几乎每一个应用程序，一旦达到一定规模，就会利用数据管道来确保数据可以被收集、存储和分析。 一个典型的管道有三个主要阶段:

1. 该应用程序将数据(通常是关于用户交互的事件)发送到数据“消防水管” ，后者提供一个流式接口来接收和处理数据。 通常，原始数据被转换或增强，并传递给另一个消防水管。 和 Kafka 是这方面最常用的两种技术
2. 原始数据以及最终的转换 / 增强数据被保存到云存储中。 Aws Kinesis 提供了一个称为“ firehose”的设置，这使得将原始数据保存到它的云存储(S3)中变得非常容易配置
3. 转换 / 增强的数据通常被加载到数据仓库中进行分析。 我们使用 AWS 红移技术，创业公司中也有很大一部分使用这种技术，而且这一比例还在不断增长，不过大公司通常会使用甲骨文或其他专有的仓库技术。 如果数据集足够大，分析可能需要类似 hadoop 的 nosqlmapreduce 技术

架构图中没有描述的另一个步骤是: 将数据从应用程序和服务的操作数据库加载到数据仓库中。 例如，在 Storyblocks，我们每天晚上将 VideoBlocks、 AudioBlocks、 Storyblocks、 account service 和 contributor portal 数据库加载到 Redshift。 通过将核心业务数据与用户交互事件数据共存，这为我们的分析师提供了一个整体数据集。



# 10. Cloud storage

“云存储是通过互联网存储、访问和共享数据的一种简单且可伸缩的方式”。 您可以使用它来存储和访问或多或少存储在本地文件系统上的任何内容，这样做的好处是可以通过 HTTP 上的 RESTful API 与它进行交互。 亚马逊的 s 3是目前最流行的云存储，也是我们在 Storyblocks 广泛使用的存储视频、图片和音频资源、 CSS 和 Javascript、用户事件数据等等的云存储。



# 11. CDN

Cdn 代表“内容传递网路” ，这项技术提供了一种通过网络提供静态 HTML、 CSS、 Javascript 和图片等资源的方式，比通过单一来源的服务器提供这些资源要快得多。 它的工作原理是将内容分布在世界各地的许多“边缘”服务器上，这样用户最终就可以从“边缘”服务器而不是原始服务器上下载资产。 例如，在下面的图片中，一个西班牙用户从一个在纽约有原始服务器的网站请求一个网页，但是该网页的静态资产是从英格兰的 CDN“ edge”服务器加载的，防止了许多缓慢的跨大西洋 HTTP 请求。

![img](https://miro.medium.com/max/1377/1*ZkC_5865Hx-Cgph3iPJghw.png)

请查看这篇文章以获得更全面的介绍。 一般来说，web 应用程序应该总是使用 CDN 来提供 CSS、 Javascript、图片、视频和其他任何资源。 一些应用程序也可以利用 CDN 来提供静态 HTML 页面。



